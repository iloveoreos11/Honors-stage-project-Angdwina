<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module" src="firebase-config.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #f8f9fa, #e0eafc);
      color: #333;
    }
    .navbar {
      background-color: #2c3e50;
    }
    .navbar-brand, .nav-link {
      color: white !important;
    }
    .nav-link:hover {
      color: #1abc9c !important;
    }
    .card {
      border: none;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(12px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }
    footer {
      background-color: #2c3e50;
      color: white;
      text-align: center;
      padding: 1rem;
      margin-top: 3rem;
      font-size: 1rem;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">üìä Reports</a>
    <div class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav gap-3">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="devices.html">Devices</a></li>
        <li class="nav-item"><a class="nav-link active" href="reports.html">Reports</a></li>
        <li class="nav-item"><a class="nav-link" href="recommendations.html">Recommendations</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#"><i class="fas fa-user-circle"></i> Account</a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="settings.html">‚öôÔ∏è Settings</a></li>
            <li><a class="dropdown-item" href="#">üîì Sign Out</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container py-5">
  <div class="card p-4">
    <h2 class="text-center mb-3">üìä Energy Reports</h2>
    <p class="text-muted text-center mb-4">üîÅ Click any column heading to sort the table by that value.</p>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Device</th>
          <th>Power (W)</th>
          <th>Usage (hrs/day)</th>
          <th>kWh / Month</th>
          <th>¬£ / Month</th>
          <th>kWh / Year</th>
          <th>¬£ / Year</th>
          <th>Monthly CO‚ÇÇ (kg)</th>
          <th>Yearly CO‚ÇÇ (kg)</th>
        </tr>
      </thead>
      <tbody id="report-table-body">
        <!-- Devices will be injected here with JavaScript -->
      </tbody>
    </table>
  </div>

  <div class="card p-4 mt-4">
    <h4>Insights</h4>
    <p><strong>Highest Monthly CO‚ÇÇ Device:</strong> <span id="max-monthly-co2-device">Loading...</span></p>
    <p><strong>Highest Yearly CO‚ÇÇ Device:</strong> <span id="max-yearly-co2-device">Loading...</span></p>
  </div>
</div>
<script type="module">
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { app } from "./firebase-config.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const devicesRef = collection(db, "users", user.uid, "devices");
    const querySnapshot = await getDocs(devicesRef);

    const tbody = document.getElementById("report-table-body");

    let maxMonthlyCO2 = 0, maxYearlyCO2 = 0;
    let maxMonthlyDevice = "", maxYearlyDevice = "";

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const { name, power, hoursPerDay, costPerKWh, carbonIntensity } = data;

      const monthlyKWh = (power * hoursPerDay * 30) / 1000;
      const yearlyKWh = (power * hoursPerDay * 365) / 1000;
      const monthlyCost = monthlyKWh * costPerKWh;
      const yearlyCost = yearlyKWh * costPerKWh;

      const monthlyCO2 = monthlyKWh * carbonIntensity;
      const yearlyCO2 = yearlyKWh * carbonIntensity;

      if (monthlyCO2 > maxMonthlyCO2) {
        maxMonthlyCO2 = monthlyCO2;
        maxMonthlyDevice = name;
      }

      if (yearlyCO2 > maxYearlyCO2) {
        maxYearlyCO2 = yearlyCO2;
        maxYearlyDevice = name;
      }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${name}</td>
        <td>${power}</td>
        <td>${hoursPerDay}</td>
        <td>${monthlyKWh.toFixed(2)}</td>
        <td>¬£${monthlyCost.toFixed(2)}</td>
        <td>${yearlyKWh.toFixed(2)}</td>
        <td>¬£${yearlyCost.toFixed(2)}</td>
        <td>${monthlyCO2.toFixed(2)}</td>
        <td>${yearlyCO2.toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById("max-monthly-co2-device").textContent = `${maxMonthlyDevice} (${maxMonthlyCO2.toFixed(2)} kg)`;
    document.getElementById("max-yearly-co2-device").textContent = `${maxYearlyDevice} (${maxYearlyCO2.toFixed(2)} kg)`;
  });
</script>
<footer>
  <p>&copy; 2025 Power Usage Dashboard. All rights reserved.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
